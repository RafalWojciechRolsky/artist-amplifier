<!-- Powered by BMAD™ Core -->

# Test Design: Story 1.2 – Przesyłanie Utworu do Analizy

- Data: 2025-08-27
- Story: [docs/stories/1.2.przesylanie-utworu-do-analizy.md](../stories/1.2.przesylanie-utworu-do-analizy.md)
- Zakres: Wybór pliku audio (.mp3/.wav ≤ 50MB), natychmiastowa walidacja, uruchomienie analizy po kliknięciu „Generuj opis”, stany UI („Gotowe do generowania” → „Analiza” → „Błąd analizy” / „Ukończono analizę”), możliwość przerwania oczekiwania, zapis wyniku analizy do sesji.

## Cele testów

- Zweryfikować zgodność z AC (1–7).
- Zredukować ryzyka z profilu ryzyka (SEC-001, TECH-001, PERF-001, OPS-001/002, DATA-001, SEC-002, BUS-001).
- Zapewnić testowalność walidacji pliku, stanów UI, obsługi błędów i sesji.

## Mapowanie wymagań → testy

- AC1: Wskazanie pliku i prezentacja nazwy – TC1.1, TC1.2
- AC2: Walidacja rozmiaru/formatu i komunikaty – TC2.1, TC2.2, TC2.3, TC2.4
- AC3: Start analizy dopiero po kliknięciu – TC3.1, TC3.2
- AC4: Status „Analiza audio…”, możliwość przerwania – TC4.1, TC4.2, TC4.3
- AC5: Błąd analizy → komunikat + zmiana pliku + retry – TC5.1, TC5.2, TC5.3
- AC6: Odbiór wyniku analizy i zapis w sesji – TC6.1, TC6.2, TC6.3
- AC7: Stany UI – „Gotowe”, „Analiza”, „Błąd” (opc. „Ukończono”) – TC7.1, TC7.2

## Scenariusze (Given–When–Then)

### 1. Wybór i prezentacja pliku (AC1)

- TC1.1 Wybór poprawnego pliku (P1, Integracja)
  Given input file akceptuje .mp3,.wav i limit 50MB
  When użytkownik wybiera plik `song.mp3` 5MB
  Then widoczna nazwa pliku i stan przechowuje referencję do pliku

- TC1.2 Odrzucenie niedozwolonego rozszerzenia (P0, Unit/Integracja) – mitigates: SEC-001
  Given input file
  When użytkownik wybiera `malicious.exe`
  Then pojawia się czytelny komunikat o niedozwolonym formacie, brak przejścia dalej

### 2. Walidacja rozmiaru/formatu i komunikaty (AC2)

- TC2.1 Limit rozmiaru > 50MB (P0, Unit/Integracja) – mitigates: SEC-001
  Given input file z limitem 50MB
  When wybór pliku 60MB
  Then komunikat o przekroczeniu limitu, brak możliwości kontynuacji

- TC2.2 MIME spoof (P0, Unit) – mitigates: SEC-001
  Given funkcja walidacji typu
  When plik `.mp3` z błędnym MIME
  Then walidacja zwraca błąd, komunikat czytelny

- TC2.3 Komunikaty dostępności (P1, A11y)
  Given wystąpił błąd walidacji
  Then komunikat powiązany z inputem (aria-describedby), ogłoszony przez aria-live

- TC2.4 Wyczyszczenie błędów po zmianie pliku (P1, Integracja)
  Given wcześniejszy błąd formatu/rozmiaru
  When użytkownik wybiera poprawny plik
  Then komunikat znika, formularz gotowy

### 3. Start analizy wyłącznie po kliknięciu (AC3)

- TC3.1 Brak automatycznego startu (P1, Unit/Integracja)
  Given wybrany poprawny plik
  Then dopóki nie kliknięto „Generuj opis” – analiza nie startuje

- TC3.2 Start po kliknięciu (P1, Integracja/E2E)
  Given wybrany poprawny plik
  When klik „Generuj opis”
  Then wywołanie API analizy audio, UI przechodzi do „Analiza”

### 4. Status „Analiza audio…” i przerwanie (AC4)

- TC4.1 Status przycisku (P1, Unit/Integracja)
  Given stan `analyzing`
  Then etykieta przycisku = „Analiza audio…”, akcje niebezpieczne zablokowane

- TC4.2 Anulowanie oczekiwania (P1, Integracja) – mitigates: OPS-001
  Given stan `analyzing`
  When użytkownik anuluje oczekiwanie
  Then UI wraca do stanu „Gotowe do generowania”, backend otrzymuje sygnał cancel

- TC4.3 Brak paska postępu (P3, UI)
  Given stan `analyzing`
  Then brak progress bara, tylko status; UI pozostaje responsywny

### 5. Obsługa błędów i retry (AC5)

- TC5.1 Mapowanie błędów dostawcy (P1, Unit/Integracja) – mitigates: SEC-002, TECH-001
  Given błąd provider API (różne kody/formaty)
  Then UI prezentuje czytelny komunikat bez wycieku detali

- TC5.2 Zmiana pliku i ponowienie (P1, E2E)
  Given błąd analizy
  When użytkownik wybiera inny plik i ponawia
  Then happy path działa, brak stanów zawieszonych

- TC5.3 Retry/backoff na błędy transient (P1, Integracja) – mitigates: OPS-002
  Given błąd typu timeout/429
  Then mechanizm retry z backoff i komunikat „spróbuj ponownie” po limitach

### 6. Odbiór i zapis wyniku w sesji (AC6)

- TC6.1 Zapis do sessionStorage (P1, Unit)
  Given udana analiza
  Then wynik zapisany pod kluczem `aa:v1:analysis:*`

- TC6.2 Odczyt i użycie wyniku (P1, Integracja)
  Given wynik w sessionStorage
  When przejście do generowania opisu
  Then dane analizy pobrane i dostępne w logice generowania

- TC6.3 Odporność na różne schematy odpowiedzi (P1, Unit/Integracja) – mitigates: TECH-001
  Given odpowiedzi dostawcy z brakującymi/dodatkowymi polami
  Then parser tolerancyjny, pola opcjonalne defaultowane, brak crasha

### 7. Stany UI (AC7)

- TC7.1 Przejścia stanów (P1, Integracja)
  Given `idle (Gotowe)`
  When klik „Generuj opis” → analiza → błąd/sukces
  Then stany: `idle → analyzing → error | completed` (opcjonalne `completed`)

- TC7.2 Widoczność i dostępność stanów (P1, A11y)
  Given zmiana stanu
  Then status tekstowy ogłaszany screen readerem; focus zarządzany logicznie

## Matryca pokrycia

| Obszar                 | Testy                                  |
| ---------------------- | -------------------------------------- |
| Format/rozmiar pliku   | TC2.1, TC2.2, TC1.2                    |
| Prezentacja nazwy      | TC1.1                                  |
| Start tylko po klik    | TC3.1, TC3.2                           |
| Status/przerwanie      | TC4.1, TC4.2, TC4.3                    |
| Obsługa błędów/retry   | TC5.1, TC5.2, TC5.3                    |
| Persistencja sesji     | TC6.1, TC6.2                           |
| Parser wyniku          | TC6.3                                  |
| Stany UI i a11y        | TC7.1, TC7.2                           |

## Poziomy testów i priorytety

- Unit: TC2.2, TC3.1, TC4.1, TC6.1, TC6.3 (szybkie, izolowane)
- Integracja: TC1.1, TC2.1, TC2.4, TC3.2, TC4.2, TC5.1, TC5.3, TC6.2, TC7.1
- E2E: TC5.2 (krytyczny przepływ błędu→retry)

Priorytety: P0: TC2.1, TC2.2; P1: większość powyżej; P3: TC4.3.

## Artefakty do dostarczenia

- Jednostkowe: walidator pliku (rozmiar/MIME), parser odpowiedzi dostawcy, obsługa `sessionStorage`.
- Integracja: testy z React Testing Library: stany, klik „Generuj opis”, anulowanie, mapowanie błędów.
- E2E (opcjonalnie w MVP): ścieżka błąd→retry→sukces.
- A11y: raport axe i ręczna checklista statusów/komunikatów.

## Zalecana kolejność uruchamiania

1) P0 Unit (SEC-001): TC2.1, TC2.2
2) P1 Integracja (start, stany, błędy): TC3.2, TC4.2, TC5.1, TC7.1
3) P1 Persistencja i parser: TC6.1, TC6.2, TC6.3
4) E2E retry: TC5.2
5) Reszta (P1/P3): TC1.1, TC2.4, TC4.1, TC4.3, TC7.2

## Gate – blok YAML (wstaw do gate)

test_design:
  scenarios_total: 20
  by_level:
    unit: 6
    integration: 13
    e2e: 1
  by_priority:
    p0: 2
    p1: 16
    p2: 1
    p3: 1
  coverage_gaps: []

## Trace – hook lines

- Test design matrix: docs/qa/assessments/1.2-przesylanie-utworu-do-analizy-test-design-20250827.md
- P0 tests identified: 2
