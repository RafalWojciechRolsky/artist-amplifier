# Requirements Traceability Matrix

## Story: 1.3 - Generowanie i Edycja Opisu

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 7 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Przycisk "Generuj opis" aktywny dopiero po spełnieniu warunków

Coverage: FULL

Given-When-Then Mappings:

- Unit Test: `src/lib/__tests__/validators.test.ts::enableGenerateButton`
  - Given: Wprowadzono poprawne dane artysty i istnieje plik audio
  - When: Walidator ocenia warunki aktywacji
  - Then: Zwraca true i UI ustawia button na aktywny
- Integration Test: `src/app/__tests__/page.integration.test.tsx::buttonStateFromReducer`
  - Given: Reducer w stanie validInputs + audioPresent
  - When: Render strony
  - Then: Przycisk ma disabled=false
- E2E Test: `src/app/__tests__/flow.e2e.test.ts::enableAfterInputs`
  - Given: Użytkownik uzupełnił Story 1.1 i przesłał audio (Story 1.2)
  - When: Otwiera ekran generowania
  - Then: Przycisk jest aktywny

#### AC2: Sekwencja stanów "Analiza audio..." → "Generowanie..."

Coverage: FULL

- Unit Test: `src/app/__tests__/reducer.test.ts::stateTransitions`
  - Given: Stan idle
  - When: Dispatch GENERATE_CLICK → ANALYZE_DONE → GENERATE_DONE
  - Then: Stany po kolei: analyzing → generating → readyDescription
- Integration Test: `src/app/__tests__/generate.integration.test.ts::orderedCallsAndLabels`
  - Given: Zamockowane API analizy i LLM z opóźnieniami
  - When: Klik na "Generuj opis"
  - Then: Etykiety zmieniają się we właściwej kolejności
- E2E Test: `src/app/__tests__/flow.e2e.test.ts::progressiveStates`
  - Given: Spowolnione odpowiedzi backendu
  - When: Generowanie
  - Then: Widzimy najpierw "Analiza audio...", potem "Generowanie..."

#### AC3: Wysyłka do API LLM z wymaganymi polami

Coverage: FULL

- Unit Test: `src/lib/__tests__/payload.test.ts::buildLLMPayload`
  - Given: Dane artysty + wynik analizy audio + szablon
  - When: Budujemy ładunek do POST `/api/audio/generate`
  - Then: JSON zawiera artistName, artistDescription, analysis, template
- Integration Test: `src/app/api/__tests__/generate.route.test.ts::contract`
  - Given: Wywołanie route handlera
  - When: Odbiera body
  - Then: Waliduje kontrakt i mapuje błędy do ApiError

#### AC4: Wygenerowany tekst pojawia się w edytowalnym textarea

Coverage: FULL

- Unit Test: `src/components/__tests__/TextEditor.test.tsx::rendersControlledTextArea`
  - Given: Wartość przekazana w propsach
  - When: Render komponentu
  - Then: Textarea ma wartość i atrybuty ARIA
- Integration Test: `src/app/__tests__/page.integration.test.tsx::bindGeneratedText`
  - Given: Zwrócony tekst z API
  - When: Zapis do stanu
  - Then: TextEditor pokazuje treść w polu

#### AC5: Użytkownik może edytować tekst

Coverage: FULL

- Unit Test: `src/components/__tests__/TextEditor.test.tsx::emitsOnChange`
  - Given: Użytkownik wpisuje tekst
  - When: onChange
  - Then: Zmiana przekazana do rodzica
- Integration Test: `src/app/__tests__/persistence.integration.test.ts::saveEditsToSession`
  - Given: Edycje w textarea
  - When: Debounced save
  - Then: sessionStorage otrzymuje nową wartość

#### AC6: Błąd analizy/generowania → komunikat i retry

Coverage: FULL

- Integration Test: `src/app/__tests__/errors.integration.test.ts::analysisFailure`
  - Given: Analiza zwraca błąd
  - When: Klik generuj
  - Then: Komunikat z instrukcją i przycisk ponów
- Integration Test: `src/app/__tests__/errors.integration.test.ts::generationFailure`
  - Given: LLM zwraca błąd
  - When: Generowanie
  - Then: Komunikat i zachowane dane użytkownika
- E2E Test: `src/app/__tests__/flow.e2e.test.ts::retryAfterError`
  - Given: Pierwsza próba kończy się błędem
  - When: Użytkownik klika ponów
  - Then: Druga próba kończy się sukcesem

#### AC7: Stan utrzymany w sesji (persistencja)

Coverage: FULL

- Unit Test: `src/lib/__tests__/storage.test.ts::saveRestore`
  - Given: Dane w kluczu `aa:v1:generated`
  - When: Odświeżenie strony
  - Then: Stan zostaje przywrócony
- Integration Test: `src/app/__tests__/persistence.integration.test.ts::restoreOnLoad`
  - Given: Zapisany stan w sessionStorage
  - When: Wejście na stronę
  - Then: UI przywraca pola i tekst

### Critical Gaps

- Brak krytycznych luk — wszystkie AC pokryte co najmniej jednym testem, kluczowe ścieżki posiadają testy integracyjne/E2E.

### Test Design Recommendations

- Wykonać testy P0 w pierwszej kolejności (kontrakt, błędy, sekwencja wywołań).
- Dodać testy negatywne dla payload buildera (sanityzacja wejścia) i mapowania błędów.
- Ustalić budżety wydajnościowe (P95) i dodać asercje czasowe w testach integracyjnych.

### Risk Assessment

- High Risk: Brak — zaadresowane przez P0 testy.
- Medium Risk: Obsługa jakości analizy — przypadki graniczne w testach payload/prompt.
- Low Risk: Persistencja i zgodność przeglądarek — scenariusze dymne + telemetry.
