# Requirements Traceability Matrix

## Story: 2.2 - Integracja LLM (OpenAI, non-stream) w BFF

### Coverage Summary

- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: A real description generated by an LLM is returned in the `text` field of the API response.

**Coverage: FULL**

- **Integration Test**: `2.2-INT-001`
  - **Given**: A valid `analysisId` and artist context.
  - **When**: The `/api/audio/generate` endpoint is called.
  - **Then**: The response body contains a `text` field with the mocked LLM-generated description.
- **Unit Test**: `2.2-UNIT-001`
  - **Given**: Artist context and audio analysis data.
  - **When**: The `generateDescription` function is called.
  - **Then**: The function returns an object containing the `text` from the mocked LLM response.
- **E2E Test**: `2.2-E2E-001`
    - **Given**: A user has successfully uploaded a track and received an `analysisId`.
    - **When**: The user clicks the "Generate" button.
    - **Then**: The UI displays the description text returned from the (mocked) API.

#### AC2: The `modelName` and `tokensUsed` fields are correctly populated in the API response.

**Coverage: FULL**

- **Integration Test**: `2.2-INT-001`
  - **Given**: A valid `analysisId` and artist context.
  - **When**: The `/api/audio/generate` endpoint is called.
  - **Then**: The response body contains `modelName` and `tokensUsed` fields matching the mocked LLM response.
- **Unit Test**: `2.2-UNIT-001`
  - **Given**: Artist context and audio analysis data.
  - **When**: The `generateDescription` function is called.
  - **Then**: The function returns an object containing `modelName` and `tokensUsed` from the mocked LLM response.

#### AC3: There are no breaking changes to the input/output contract of the `/api/audio/generate` endpoint.

**Coverage: FULL**

- **Integration Test**: `2.2-INT-001` (Happy Path)
  - **Given**: A valid request payload.
  - **When**: The `/api/audio/generate` endpoint is called.
  - **Then**: The response schema matches the `GeneratedDescription` interface.
- **Integration Test**: `2.2-INT-002` (Failure Path)
  - **Given**: The downstream LLM service will fail.
  - **When**: The `/api/audio/generate` endpoint is called.
  - **Then**: The error response schema matches the `ApiError` interface.
- **Unit Test**: `2.2-UNIT-002` & `2.2-UNIT-003`
    - **Given**: The LLM provider will return a 500 or 429 error.
    - **When**: The `generateDescription` function is called.
    - **Then**: The function throws a standardized error that the API route can map to the `ApiError` contract.

#### AC4: The `.env.example` and `README.md` files are updated with the new environment variables `LLM_API_KEY` and `LLM_MODEL`.

**Coverage: FULL**

- **Manual Test**: `2.2-MANUAL-001`
  - **Given**: A developer is setting up the project.
  - **When**: They consult the `README.md` and `.env.example` files.
  - **Then**: They find clear instructions and placeholders for the `LLM_API_KEY` and `LLM_MODEL` variables.

### Critical Gaps

None identified. All acceptance criteria are covered by at least one test case.

### Test Design Recommendations

The current test design is comprehensive. No additional tests are recommended at this time.
