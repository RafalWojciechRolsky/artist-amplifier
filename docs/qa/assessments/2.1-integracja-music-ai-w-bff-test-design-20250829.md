# Test Design: Story 2.1

Date: 2025-08-29
Designer: Quinn (Test Architect)

## Test Strategy Overview

This test design focuses on the backend integration with the Music.ai service. The strategy prioritizes integration tests to validate the interactions between the API route, the new Music.ai service module, and the (mocked) external SDK. Unit tests will cover specific data transformation and retry logic, while a single E2E smoke test ensures the frontend contract remains unbroken.

- Total test scenarios: 7
- Unit tests: 2 (29%)
- Integration tests: 4 (57%)
- E2E tests: 1 (14%)
- Manual tests: 1
- Priority distribution: P0: 2, P1: 3, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: A real call to the Music.ai service is made when generating a description.

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 2.1-INT-001 | Integration | P0 | BFF API route calls the Music.ai service module | Validates the primary interaction between internal components. |
| 2.1-INT-002 | Integration | P0 | Music.ai service calls the (mocked) SDK with correct parameters | Ensures the external dependency is invoked correctly. |
| 2.1-UNIT-001| Unit | P1 | Raw SDK result is correctly mapped to the `AudioAnalysis` model | Verifies data transformation logic in isolation. |

### AC2: Errors from the Music.ai service are mapped to the standard `ApiError` format.

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 2.1-INT-003 | Integration | P1 | Mocked 5xx SDK error results in a 502 `ApiError` response | Validates the critical error handling path between components. |
| 2.1-INT-004 | Integration | P1 | Mocked 429 SDK error triggers retry and eventually returns a 429 `ApiError` | Validates the resilience and error handling of the integration. |
| 2.1-UNIT-002| Unit | P2 | Retry logic implements correct exponential backoff timing | Verifies the correctness of the retry algorithm itself. |

### AC3: There are no changes to the request format from the frontend.

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 2.1-E2E-001 | E2E | P1 | Full flow from file upload to a successful (mocked) response | Smoke test to prevent regressions and ensure the API contract is stable. |

### AC4: The `.env.example` and `README.md` files are updated.

| ID | Level | Priority | Test | Justification |
| :--- | :--- | :--- | :--- | :--- |
| 2.1-MANUAL-001| Manual | P2 | Inspect `.env.example` and `README.md` for new variables | Configuration and documentation check that cannot be automated. |

## Risk Coverage

- **TECH-001 (Service Dependency):** Covered by 2.1-INT-003, 2.1-INT-004.
- **PERF-001 (Long Processing):** Partially covered by E2E test, but requires dedicated performance testing later.
- **OPS-001 (File Handling):** Not explicitly covered, but can be added to integration test cleanup steps.

## Recommended Execution Order

1.  P0 Integration tests (2.1-INT-001, 2.1-INT-002).
2.  P1 Unit and Integration tests (2.1-UNIT-001, 2.1-INT-003, 2.1-INT-004).
3.  P1 E2E test (2.1-E2E-001).
4.  P2 tests as time permits.
