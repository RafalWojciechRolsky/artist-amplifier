# Risk Profile: Story 1.2 — Przesyłanie utworu do analizy

Date: 2025-08-27
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 0
- High Risks: 1
- Risk Score: 58/100

Key theme: handling untrusted file uploads and long-running, provider-dependent audio analysis with clear UX states, robust validation, and safe error handling.

## Critical Risks Requiring Immediate Attention

None identified as Critical (score 9). The most significant risk is High (score 6) and must be mitigated before production.

## Risk Distribution

### By Category

- Security: 2 risks (0 critical, 1 high)
- Performance: 1 risk (0 critical)
- Data: 1 risk (0 critical)
- Business: 1 risk (0 critical)
- Operational: 2 risks (0 critical)
- Technical: 1 risk (0 critical)

### By Component

- Frontend: 3 risks (validation, UX states, error messaging)
- Backend/API: 4 risks (validation on server, error handling, retries, parsing)
- Infrastructure: 1 risk (upload pipeline/timeouts)

## Risk Matrix

| Risk ID  | Description                                                                 | Probability | Impact     | Score | Priority |
| -------- | --------------------------------------------------------------------------- | ----------- | ---------- | ----- | -------- |
| SEC-001  | Inadequate file-type validation enabling malicious payloads                 | Medium (2)  | High (3)   | 6     | High     |
| TECH-001 | Provider response variability breaks parsing/session state                  | Medium (2)  | Medium (2) | 4     | Medium   |
| PERF-001 | Upload/analysis timeouts for ~50MB files or slow network                    | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001 | Storage bloat/compliance concerns for uploaded audio retention              | Medium (2)  | Medium (2) | 4     | Medium   |
| OPS-001  | Cancellation not honored → zombie jobs / orphaned analysis tasks            | Medium (2)  | Medium (2) | 4     | Medium   |
| OPS-002  | Missing retries/backoff/idempotency for upload/analysis API calls           | Medium (2)  | Medium (2) | 4     | Medium   |
| SEC-002  | Overly-detailed error messages leak internals via UI/API                    | Medium (2)  | Medium (2) | 4     | Medium   |
| BUS-001  | Insufficient UX during analysis state leads to user abandonment/confusion   | Medium (2)  | Low (1)    | 2     | Low      |

## Detailed Risk Register and Mitigations

### SEC-001: Inadequate file-type validation enabling malicious payloads (Score 6, High)
- Probability: Medium — Client-side checks are easy to bypass; upload endpoints often drift.
- Impact: High — Potential RCE via transcoder, or abuse via polyglot files; security incident.
- Mitigation (preventive):
  - Enforce server-side validation: extension whitelist [.mp3, .wav] AND content-type sniffing.
  - Inspect magic bytes (MIME sniff) and reject mismatches.
  - Limit size ≤ 50MB server-side; hard fail with 413.
  - Store uploads in a quarantine bucket; scan with AV/Malware scanner if available.
  - Never process inline; use isolated worker/job with least privileges.
- Testing requirements:
  - Upload fuzz tests (wrong extensions, MIME spoofing, polyglot samples).
  - Unit tests for MIME sniff/size checks; e2e for rejection flows.
- Residual risk: Low with AV and strict server validation.
- Owner: dev; Timeline: before enabling uploads in prod.

### TECH-001: Provider response variability breaks parsing/session state (Score 4, Medium)
- Probability: Medium — "zakres i pola wyników zależą od dostawcy" per story.
- Impact: Medium — Broken UI states; lost analysis results in session.
- Mitigation (preventive/corrective):
  - Define a stable internal schema; map provider response with tolerant parsing (Zod/TS types, optional fields).
  - Version the mapping; default values for missing fields.
  - Contract tests with recorded provider payloads; feature-flag provider changes.
- Testing requirements: schema validation unit tests; integration tests with fixtures.
- Residual risk: Low-Medium.

### PERF-001: Upload/analysis timeouts for ~50MB files or slow network (Score 4, Medium)
- Probability: Medium — Large files + serverless timeouts.
- Impact: Medium — Failed uploads; degraded UX.
- Mitigation (preventive):
  - Use pre-signed direct-to-object-store uploads with multi-part if possible.
  - Configure generous but bounded timeouts; client retries with exponential backoff.
  - Background analysis via job queue; UI polls/callbacks.
- Testing requirements: network throttling tests; large-file e2e.
- Residual risk: Low-Medium.

### DATA-001: Storage retention & compliance for uploaded audio (Score 4, Medium)
- Probability: Medium — Temporary files linger.
- Impact: Medium — Cost, compliance/privacy exposure.
- Mitigation (preventive):
  - Time-bound retention (TTL / lifecycle rules); auto-delete after N days or on analysis completion.
  - Access controls and encryption at rest; avoid PII in paths.
- Testing requirements: lifecycle policy tests; delete-on-complete integration tests.
- Residual risk: Low.

### OPS-001: Cancellation not honored → zombie jobs (Score 4, Medium)
- Probability: Medium — UX allows cancel; backend may not.
- Impact: Medium — Wasted compute, billing, inconsistent UI states.
- Mitigation (corrective):
  - Propagate cancel tokens/IDs to worker; best-effort abort.
  - Idempotent job status; periodic sweeper to clean stuck jobs.
- Testing requirements: cancel e2e; race conditions.
- Residual risk: Low-Medium.

### OPS-002: Missing retries/backoff/idempotency (Score 4, Medium)
- Probability: Medium — Transient provider failures typical.
- Impact: Medium — User-visible errors; duplicate work.
- Mitigation (preventive/detective):
  - Exponential backoff with jitter; idempotency keys for start-analysis.
  - Distinguish transient vs permanent errors; circuit breaker.
- Testing requirements: fault injection; chaos tests on provider dependency.
- Residual risk: Low.

### SEC-002: Error detail leakage (Score 4, Medium)
- Probability: Medium — Common to bubble raw errors to UI.
- Impact: Medium — Information disclosure.
- Mitigation (preventive):
  - Sanitize server errors; map to user-friendly messages.
  - Central error handler with safe codes; log sensitive details server-side only.
- Testing requirements: snapshot tests of error surfaces.
- Residual risk: Low.

### BUS-001: Insufficient UX during analysis (Score 2, Low)
- Probability: Medium — No progress bar; only status text per ACs.
- Impact: Low — Confusion; abandonment.
- Mitigation (preventive):
  - Clear state transitions: "Gotowe do generowania" → "Analiza" → "Błąd"/"Ukończono".
  - Provide cancel and retry affordances; disable unsafe actions during analysis.
- Testing requirements: UX state flows; accessibility of status messages.
- Residual risk: Low.

## Risk-Based Testing Strategy

### Priority 1: Critical/High Risk Tests
- Malicious file upload attempts (polyglot, MIME spoof, oversize) → expect safe rejection.
- Server-side validation and quarantine/scan paths.

### Priority 2: Medium Risk Tests
- Provider response mapping with missing/extra fields (schema validation).
- Large-file upload under throttled network; timeout/retry behavior.
- Cancel analysis mid-flight; verify no zombie job and consistent UI state.
- Retry/backoff with idempotency keys; resilience to transient failures.
- Error sanitization: UI shows safe messages; server logs contain detail.

### Priority 3: Low Risk Tests
- UX states visibility and transitions; a11y announcements for status changes.
- Regression on session storage of analysis result.

## Risk Acceptance Criteria

### Must Fix Before Production
- SEC-001 mitigations (server-side validation, scanning/quarantine).
- Retry/backoff and idempotency for analysis start.

### Can Deploy with Mitigation
- Medium risks with compensating controls (timeouts, background jobs, schema mapping).

### Accepted Risks
- Lack of progress bar if status text + cancel meets UX needs (documented).

## Monitoring Requirements
- Metrics: upload/analysis success rate, duration, timeout rate.
- Alerts: spikes in 4xx (validation) and 5xx (provider), job queue backlog.
- Security: AV scan detections, rejected uploads by MIME sniff.
- Business: abandonment rate during analysis state.

## Risk Review Triggers
- Provider API change; new response fields or deprecations.
- Increase in upload failures/timeouts or storage growth.
- Security bulletin related to audio processing libs.

---

# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 6
    low: 1
  highest:
    id: SEC-001
    score: 6
    title: 'Inadequate file-type validation enabling malicious payloads'
  recommendations:
    must_fix:
      - 'Server-side validation (magic bytes, size limit) and quarantine/AV scan'
      - 'Implement retries/backoff with idempotency for analysis start'
    monitor:
      - 'Timeout rates for uploads/analysis and job queue backlog'
      - 'Provider response parsing errors and schema violations'
