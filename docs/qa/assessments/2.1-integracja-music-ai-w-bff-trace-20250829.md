# Requirements Traceability Matrix

## Story: 2.1 - Integracja Music.ai w BFF (real)

### Coverage Summary

- Total Requirements: 4
- Fully Covered: 0 (0%)
- Partially Covered: 0 (0%)
- Not Covered: 4 (100%)

### Requirement Mappings

#### AC1: A real call to the Music.ai service is made when generating a description.

**Coverage: NONE**

**Given-When-Then Mappings:**

- **Unit Test**: `src/lib/server/musicai.test.ts::analyzeAudio`
  - **Given**: A valid audio file path.
  - **When**: The `analyzeAudio` function is called.
  - **Then**: The `@music.ai/sdk` `uploadFile`, `addJob`, and `waitForJobCompletion` methods are called in sequence, and the result is mapped to the `AudioAnalysis` model.
- **Integration Test**: `src/app/api/audio/generate/route.test.ts`
  - **Given**: An incoming POST request with an audio file.
  - **When**: The API route is invoked.
  - **Then**: The real Music.ai service is called (in a controlled test environment) and a valid `AudioAnalysis` is returned.

#### AC2: Errors from the Music.ai service are mapped to the standard `ApiError` format with codes 502 or 429 and include a `requestId`.

**Coverage: NONE**

**Given-When-Then Mappings:**

- **Unit Test**: `src/lib/server/musicai.test.ts::analyzeAudio`
  - **Given**: The Music.ai SDK is mocked to throw a 429 (Too Many Requests) error.
  - **When**: The `analyzeAudio` function is called.
  - **Then**: The function catches the error and re-throws a standardized `ApiError` with code `429`.
- **Unit Test**: `src/lib/server/musicai.test.ts::analyzeAudio`
  - **Given**: The Music.ai SDK is mocked to throw a 502 (Bad Gateway) error.
  - **When**: The `analyzeAudio` function is called.
  - **Then**: The function catches the error and re-throws a standardized `ApiError` with code `502`.
- **Integration Test**: `src/app/api/audio/generate/route.test.ts`
  - **Given**: The Music.ai service is configured to return an error.
  - **When**: The API route is invoked with an audio file.
  - **Then**: The API returns a JSON response matching the `ApiError` format with the correct status code and a `requestId`.

#### AC3: There are no changes to the request format from the frontend, and the frontend (`src/lib/api/generate.ts`) continues to work without modification.

**Coverage: NONE**

**Given-When-Then Mappings:**

- **E2E Test**: `e2e/audio-upload.test.ts`
  - **Given**: A user is on the audio upload page.
  - **When**: They upload an audio file and click "Generate".
  - **Then**: The request is sent, and the analysis is displayed without any frontend console errors related to the API call structure.

#### AC4: The `.env.example` and `README.md` files are updated with the new environment variables `MUSIC_AI_API_KEY` and `MUSIC_AI_WORKFLOW_ANALYZE`.

**Coverage: NONE**

**Given-When-Then Mappings:**

- **Manual Verification**:
  - **Given**: The project codebase.
  - **When**: The `.env.example` file is inspected.
  - **Then**: It contains the `MUSIC_AI_API_KEY` and `MUSIC_AI_WORKFLOW_ANALYZE` variables.
- **Manual Verification**:
  - **Given**: The project codebase.
  - **When**: The `README.md` file is inspected.
  - **Then**: It contains documentation for the `MUSIC_AI_API_KEY` and `MUSIC_AI_WORKFLOW_ANALYZE` environment variables.

### Critical Gaps

1.  **Unit Test Coverage**
    - **Gap**: No unit tests exist for the new `src/lib/server/musicai.ts` module. The story explicitly requires mocking the `@music.ai/sdk`.
    - **Risk**: High - The core logic for interacting with the external service is untested, including success paths, error handling, and data mapping.
    - **Action**: Implement unit tests as described in the story's "Tasks / Subtasks".

2.  **Integration Test Coverage**
    - **Gap**: No integration tests for the `src/app/api/audio/generate/route.ts` endpoint to verify the full flow.
    - **Risk**: High - Without integration tests, there is no guarantee that the frontend, BFF, and Music.ai service (even a mocked version) work together correctly. Error mapping and the "no-change" requirement for the frontend (AC3) are not verified.
    - **Action**: Create integration tests for the API endpoint that simulate file uploads and verify both successful responses and correct error responses.

3.  **E2E Test Coverage**
    - **Gap**: No end-to-end test to confirm the feature works from the user's perspective.
    - **Risk**: Medium - While unit and integration tests cover the implementation details, an E2E test is needed to confirm that the frontend and backend are correctly integrated in a production-like environment.
    - **Action**: Create an E2E test that simulates the full user workflow of uploading a track and receiving an analysis.

### Test Design Recommendations

1.  **Unit Tests (`src/lib/server/musicai.test.ts`)**:
    - **Scenarios**:
        - Successful analysis: Mock the SDK to return a valid job result and assert that it's correctly mapped to the `AudioAnalysis` model.
        - SDK throws 429 error: Assert that the retry mechanism is triggered and that the final error is a correctly formatted `ApiError` with code `429`.
        - SDK throws 5xx error: Assert that the retry mechanism is triggered and that the final error is a correctly formatted `ApiError` with code `502`.
        - SDK throws an unexpected error: Assert that a generic `ApiError` is returned.
    - **Mocks**: The `@music.ai/sdk` must be completely mocked.

2.  **Integration Tests (`src/app/api/audio/generate/route.test.ts`)**:
    - **Scenarios**:
        - Valid audio file upload results in a 200 OK and `AudioAnalysis` payload.
        - Invalid file type results in a 400 Bad Request.
        - Music.ai integration returns a 429 error, and the API correctly returns a 429 `ApiError`.
        - Music.ai integration returns a 502 error, and the API correctly returns a 502 `ApiError`.
    - **Mocks**: The `src/lib/server/musicai.ts` module should be mocked to simulate success and different failure modes without making real external calls.

### Risk Assessment

- **High Risk**: All requirements currently have no test coverage. The lack of unit and integration tests for the external service interaction is a critical gap.
