# Requirements Traceability Matrix

## Story: 3.1 - Add Song Title Input

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 0 (0%)
- Partially Covered: 0 (0%)
- Not Covered: 5 (100%)

*Note: Coverage is currently 0% as development has not started. This report outlines the planned test coverage.*

### Requirement Mappings

#### AC1: A new text input field labeled "Song Title" is added to the main form.

**Planned Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/components/ArtistForm.tsx`
  - **Given**: The `ArtistForm` component is rendered.
  - **When**: The form is displayed on the page.
  - **Then**: It contains a text input field with the label "Song Title".

- **E2E Test**: `e2e/smoke-test.ts`
  - **Given**: The user navigates to the main page of the application.
  - **When**: The page finishes loading.
  - **Then**: The "Song Title" input field is visible within the form.

#### AC2: The "Song Title" field is required.

**Planned Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/components/ArtistForm.tsx`
  - **Given**: The `ArtistForm` is rendered with an empty "Song Title" field.
  - **When**: The user attempts to submit the form.
  - **Then**: A validation error message is displayed for the "Song Title" field, and the submission is blocked.

- **E2E Test**: `e2e/form-validation.test.ts`
  - **Given**: The user is on the main page.
  - **When**: They fill out all other required fields but leave "Song Title" blank and click "Generate".
  - **Then**: The form submission is prevented, and a required field error is displayed next to the "Song Title" input.

#### AC3: The entered song title is sent to the backend along with the other artist and audio information.

**Planned Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/lib/api/generate.ts`
  - **Given**: The user has filled out the form, including a "Song Title".
  - **When**: The `generate` API function is called with the form data.
  - **Then**: The `fetch` call to `/api/audio/generate` is made with a JSON payload that includes the `songTitle`.

- **E2E Test**: `e2e/form-submission.test.ts`
  - **Given**: The user is on the main page and has filled out all fields, including "Song Title".
  - **When**: They click the "Generate" button.
  - **Then**: A network request to `/api/audio/generate` is intercepted, and its payload is verified to contain the correct `songTitle`.

#### AC4: The backend associates the song title with the analysis job.

**Planned Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/app/api/audio/generate/route.ts`
  - **Given**: A POST request is received at the `/api/audio/generate` endpoint containing a `songTitle` in its JSON body.
  - **When**: The request handler processes the request.
  - **Then**: The `songTitle` is correctly extracted from the body and passed as an argument to the downstream analysis service (e.g., `llm.generateDescription`).

#### AC5: The song title is used in the prompt for generating the final description.

**Planned Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/lib/server/llm.ts`
  - **Given**: The `generateDescription` function is called with parameters that include a `songTitle`.
  - **When**: The function constructs the prompt for the LLM.
  - **Then**: The resulting prompt string is verified to include the `songTitle` in the correct context.

### Critical Gaps

- **Gap**: No test coverage currently exists for any acceptance criteria.
- **Risk**: High - All requirements are unverified.
- **Action**: Implement the unit and E2E tests as outlined in the "Requirement Mappings" section and the story's "Testing Requirements".

### Test Design Recommendations

1.  **Unit Tests**: Focus on component-level validation in `ArtistForm.tsx` and logic verification in the API client (`generate.ts`), backend route (`route.ts`), and LLM service (`llm.ts`).
2.  **E2E Tests**: Create a dedicated test file (`e2e/add-song-title.test.ts`) or update existing ones to cover the full user flow: filling the new field, validating it, submitting the form, and verifying the network payload.
3.  **Test Data**: Use a variety of song titles, including simple, complex, and special character strings, to ensure robust handling.

### Risk Assessment

- **High Risk**: All requirements currently have no test coverage, making them high-risk. The risk will be mitigated as the planned tests are implemented.
