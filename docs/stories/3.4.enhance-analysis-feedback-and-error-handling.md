# <!-- Powered by BMAD™ Core -->

# Story 3.4: Enhance Analysis Feedback and Error Handling

## Status

Done

## Story

**As a** user,
**I want** to receive specific feedback and error messages during the analysis process,
**so that** I understand what is happening and can react to problems.

## Acceptance Criteria

1.  **Komunikaty o Stanie:** Interfejs wyświetla specyficzne komunikaty dla każdego etapu procesu: `analizowanie`, `oczekiwanie w tle (polling)`, `generowanie`.
2.  **Obsługa Długiej Analizy:** Gdy analiza trwa długo, interfejs informuje użytkownika, że proces działa w tle i regularnie sprawdza jego status.
3.  **Obsługa Błędów:** W przypadku błędu na dowolnym etapie, użytkownik widzi zrozumiały komunikat błędu.
4.  **Stan Początkowy i Po Analizie:**
    - Po załadowaniu strony i po przesłaniu pliku, przycisk **"Generuj opis"** jest widoczny, ale **wyłączony (disabled)**.
    - Gdy analiza utworu zakończy się sukcesem, przycisk **"Generuj opis"** staje się **aktywny**.
    - W tym stanie (po analizie, przed generowaniem) elementy takie jak pole tekstowe na opis, tytuł "Wygenerowany opis" oraz przyciski "Kopiuj" i "Pobierz" **nie są widoczne**.
5.  **Stan Generowania Opisu:**
    - Podczas generowania opisu (stan `generating`), przyciski **"Analizuj utwór"** i **"Generuj opis"** są **wyłączone**. Wyświetlany jest status "Generowanie...".
6.  **Stan Końcowy (Opis Gotowy):**
    - Dopiero po pomyślnym wygenerowaniu opisu, na ekranie pojawiają się następujące elementy:
      - Tytuł "Wygenerowany opis".
      - Pole tekstowe (`TextEditor`) z wygenerowanym opisem.
      - Przycisk "Kopiuj do schowka".
      - Przycisk "Pobierz jako .txt".
7.  **Układ Przycisków:**
    - Przycisk **"Generuj opis"** znajduje się w tej samej sekcji, obok przycisku **"Analizuj utwór"**.
    - Przyciski **"Kopiuj do schowka"** i **"Pobierz jako .txt"** znajdują się bezpośrednio nad polem tekstowym z opisem.
    - Przycisk **"Reset"** jest widoczony przez cały czas obok głównych przycisków akcji.
8.  **Wskaźnik Postępu (Stepper):** Interfejs wyświetla wskaźnik postępu składający się z 4 etapów: "1. Dane artysty", "2. Analiza utworu", "3. Generowanie opisu", "4. Gotowe". Aktualny etap jest wizualnie wyróżniony i zmienia się zgodnie ze stanem aplikacji.

## Dev Notes

### Previous Story Insights

The previous stories have established the core upload and validation flow. This story builds on that by making the asynchronous process more transparent to the user. The main state is managed by a `useReducer` in `src/app/page.tsx`.

### State Management

- The main state machine in `src/app/page.tsx` should be expanded to include more granular states: `idle` → `validating` → `analyzing` → `polling` → `generating` → `readyDescription` (and `error`). [Source: docs/architecture/6-components.md]
- The `jobId` received from the `/api/audio/analyze` endpoint must be stored in the component's state to be used for polling the `/api/audio/analyze/status` endpoint. [Source: docs/architecture/8-core-workflows-mermaid-sequence.md]

### API Specifications

- The frontend will interact with four endpoints in sequence:
  1. `POST /api/validate-audio`
  2. `POST /api/audio/analyze` (may return `202 Accepted` with a `jobId`)
  3. `GET /api/audio/analyze/status` (used for polling)
  4. `POST /api/audio/generate`
- All error responses will conform to the `ApiError` interface. The `message` from the error object should be displayed to the user. [Source: docs/architecture/4-data-models.md, docs/architecture/coding-standards.md]

### Polling Strategy

To ensure system stability and good user experience, the polling mechanism should be implemented with the following parameters:

- **Initial Interval:** 1000ms
- **Backoff Factor:** 1.5
- **Max Interval:** 10,000ms
- **Timeout:** 120,000ms (2 minutes)
  After the timeout, the process should be considered failed and an appropriate error message displayed to the user.

### Component Specifications

- **`src/app/page.tsx`**: Will manage the expanded state machine and orchestrate the API calls.
- **`src/components/AnalysisStatus.tsx`**: A new or updated component to display the detailed status messages corresponding to the new states (`validating`, `analyzing`, `polling`, `generating`). [Source: docs/architecture/6-components.md]
- **Generate button integration**: The generate action is rendered from `src/app/page.tsx` via `ArtistForm`'s `extraActionsRight`. The button's text and disabled state are driven by the reducer status (`ready`, `generating`, `readyDescription`). [Source: docs/architecture/6-components.md]
- **`src/components/ErrorBanner.tsx`**: This existing component will be used to display any errors that occur during the process. [Source: docs/architecture/10-frontend-architecture.md]
- **Generated description section**: The `TextEditor` (file: `src/components/TextEditor.tsx`) is shown only when the state is `readyDescription`. `ActionButtons` (copy/download) render directly above the editor in this state.
- **`src/components/Stepper.tsx`**: Nowy komponent do wyświetlania 4 etapów procesu. Jego stan musi być zsynchronizowany z głównym reducerem w `page.tsx`.

### File Locations

- State management and orchestration logic in `src/app/page.tsx`.
- New/updated UI components in `src/components/`.
- API client functions in `src/lib/api/client.ts` (or similar). [Source: docs/architecture/source-tree.md]

### Testing Requirements

- Update unit tests for the main reducer to cover the new states and transitions.
- Update E2E tests to simulate the polling workflow and verify that the correct UI feedback and error messages are displayed for each state. [Source: docs/architecture/coding-standards.md]
- Dodać testy jednostkowe dla komponentu `Stepper.tsx`.
- Zaktualizować testy E2E, aby weryfikowały poprawność działania wskaźnika postępu.

## Tasks / Subtasks

- [x] **Task 1: Rozszerzenie Maszyny Stanów** (AC: 1, 2, 5)
  - [x] W `src/app/page.tsx`, zaktualizuj `useReducer`, aby zarządzał stanami: `validating`, `analyzing`, `polling`, `generating`.
  - [x] Dodaj `jobId` do stanu reducera, aby przechowywać go na potrzeby odpytywania (polling).
- [x] **Task 2: Implementacja Logiki Odpytywania (Polling)** (AC: 2)
  - [x] Zaimplementuj mechanizm odpytywania (np. używając `setInterval` lub rekurencyjnego `setTimeout`), który respektuje zdefiniowaną strategię (exponential backoff, timeout).
  - [x] Zatrzymaj odpytywanie, gdy status przestanie być "processing" i przejdź do następnego kroku lub obsłuż błąd.
- [x] **Task 3: Implementacja Obsługi Błędów** (AC: 3)
  - [x] Opakuj wszystkie wywołania API w bloki `try...catch`.
  - [x] Upewnij się, że komponent `ErrorBanner.tsx` poprawnie wyświetla komunikat o błędzie.
- [x] **Task 4: Implementacja Logiki i Układu UI** (AC: 4, 5, 6, 7)
  - [x] **Subtask 4.1 (Układ przycisków):** Przenieś przycisk **"Generuj opis"** tak, aby znajdował się obok przycisku **"Analizuj utwór"**. Upewnij się, że przycisk **"Reset"** jest również w tej samej grupie.
  - [x] **Subtask 4.2 (Stany przycisków):** Zaimplementuj logikę, dzięki której przycisk "Generuj opis" jest wyłączony (disabled) do momentu pomyślnego zakończenia analizy, a następnie staje się aktywny. Upewnij się, że główne przyciski akcji są wyłączone w stanie `generating`.
  - [x] **Subtask 4.3 (Warunkowe renderowanie):** Zaimplementuj logikę, która sprawi, że tytuł "Wygenerowany opis", pole `TextEditor` oraz przyciski "Kopiuj do schowka" i "Pobierz jako .txt" będą renderowane **tylko i wyłącznie** po pomyślnym wygenerowaniu opisu (w stanie `readyDescription`).
  - [x] **Subtask 4.4 (Pozycja przycisków opisu):** Umieść przyciski "Kopiuj do schowka" i "Pobierz jako .txt" bezpośrednio nad polem `TextEditor`.
- [x] **Task 5: Aktualizacja Testów**
  - [x] Zaktualizuj testy jednostkowe dla reducera, aby obejmowały nowe stany i przejścia, w tym logikę widoczności komponentów.
  - [x] Zaktualizuj testy E2E (Playwright), aby zweryfikowały nowy układ UI oraz poprawność wyświetlania/ukrywania elementów w poszczególnych stanach.
- [x] **Task 6: Implementacja Wskaźnika Postępu (Stepper)**
  - [x] Stwórz nowy komponent `src/components/Stepper.tsx`, który będzie renderował etapy (1. Dane artysty, 2. Analiza utworu, 3. Generowanie opisu, 4. Gotowe) zgodnie z zaktualizowaną specyfikacją.
  - [x] Zintegruj komponent `Stepper` w `src/app/page.tsx`.
  - [x] Połącz stan wskaźnika postępu z główną maszyną stanów aplikacji, aby poprawnie podświetlał aktualny etap.

## QA Results

### Review Date: 2025-09-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is of high quality. The state management in `page.tsx` is clean and robust, correctly handling the complex user flow. The analysis logic in `lib/analysis.ts` is well-structured, with excellent error handling and testability considerations. The developer's proactivity in creating detailed QA documents (risk, test design, traceability) is highly commendable.

### Refactoring Performed

None required. The code is clean and adheres to standards.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Based on the excellent Test Design document)
- All ACs Met: [✓]

### Improvements Checklist

- [x] **Action Item:** Mark all tasks and subtasks in this story as complete (`[x]`). (Verified as complete)
- [x] **Action Item:** Run all tests (unit and E2E) to ensure they pass before moving the story to "Done". (All 21 unit test suites and 8 E2E tests passed).

### Security Review

No security issues were identified. The polling mechanism includes backoff and timeout strategies that mitigate potential DoS risks.

### Performance Considerations

Performance has been well-considered. The polling strategy prevents excessive server load, and the UI remains responsive during background processing.

### Files Modified During Review

- `docs/stories/3.4.enhance-analysis-feedback-and-error-handling.md`
- `docs/qa/gates/3.4-enhance-analysis-feedback-and-error-handling.yml`

### Gate Status

Gate: PASS → `docs/qa/gates/3.4-enhance-analysis-feedback-and-error-handling.yml`

### Recommended Status

[✓] Ready for Done
