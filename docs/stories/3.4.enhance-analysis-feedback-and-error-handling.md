# <!-- Powered by BMAD™ Core -->

# Story 3.4: Enhance Analysis Feedback and Error Handling

## Status

Draft

## Story

**As a** user,
**I want** to receive specific feedback and error messages during the analysis process,
**so that** I understand what is happening and can react to problems.

## Acceptance Criteria

1.  The UI displays a specific message for each major step of the analysis: `validating`, `analyzing`, `polling`, `generating`.
2.  When the analysis is taking a long time and the backend returns a `202-Accepted` with a `jobId`, the UI enters a "polling" state and informs the user that the analysis is running in the background.
3.  If any API call (`validate`, `analyze`, `status`, `generate`) fails, a user-friendly error message from the `ApiError` response is displayed in the `ErrorBanner` component.
4.  The `GenerateButton` is disabled during all intermediate states (`validating`, `analyzing`, `polling`, `generating`) and shows a relevant label for the current state.
5.  The description text area (`TextEditor`) is only rendered after the description has been successfully generated (i.e., in the `readyDescription` state). It must not be visible before this state.

## Dev Notes

### Previous Story Insights

The previous stories have established the core upload and validation flow. This story builds on that by making the asynchronous process more transparent to the user. The main state is managed by a `useReducer` in `src/app/page.tsx`.

### State Management

- The main state machine in `src/app/page.tsx` should be expanded to include more granular states: `idle` → `validating` → `analyzing` → `polling` → `generating` → `readyDescription` (and `error`). [Source: docs/architecture/6-components.md]
- The `jobId` received from the `/api/audio/analyze` endpoint must be stored in the component's state to be used for polling the `/api/audio/analyze/status` endpoint. [Source: docs/architecture/8-core-workflows-mermaid-sequence.md]

### API Specifications

- The frontend will interact with four endpoints in sequence:
  1. `POST /api/validate-audio`
  2. `POST /api/audio/analyze` (may return `202 Accepted` with a `jobId`)
  3. `GET /api/audio/analyze/status` (used for polling)
  4. `POST /api/audio/generate`
- All error responses will conform to the `ApiError` interface. The `message` from the error object should be displayed to the user. [Source: docs/architecture/4-data-models.md, docs/architecture/coding-standards.md]

### Polling Strategy

To ensure system stability and good user experience, the polling mechanism should be implemented with the following parameters:
- **Initial Interval:** 1000ms
- **Backoff Factor:** 1.5
- **Max Interval:** 10,000ms
- **Timeout:** 120,000ms (2 minutes)
After the timeout, the process should be considered failed and an appropriate error message displayed to the user.

### Component Specifications

- **`src/app/page.tsx`**: Will manage the expanded state machine and orchestrate the API calls.
- **`src/components/AnalysisStatus.tsx`**: A new or updated component to display the detailed status messages corresponding to the new states (`validating`, `analyzing`, `polling`, `generating`). [Source: docs/architecture/6-components.md]
- **`src/components/GenerateButton.tsx`**: The button's text and disabled state should be dynamically updated based on the current state from the main reducer. [Source: docs/architecture/6-components.md]
- **`src/components/ErrorBanner.tsx`**: This existing component will be used to display any errors that occur during the process. [Source: docs/architecture/10-frontend-architecture.md]
- **`src/components/DescriptionPreview.tsx`**: The visibility of this component, which contains the `TextEditor`, should be controlled by the application state. It should only be visible when the state is `readyDescription`.

### File Locations

- State management and orchestration logic in `src/app/page.tsx`.
- New/updated UI components in `src/components/`.
- API client functions in `src/lib/api/client.ts` (or similar). [Source: docs/architecture/source-tree.md]

### Testing Requirements

- Update unit tests for the main reducer to cover the new states and transitions.
- Update E2E tests to simulate the polling workflow and verify that the correct UI feedback and error messages are displayed for each state. [Source: docs/architecture/coding-standards.md]

## Tasks / Subtasks

- [ ] **Task 1: Extend State Machine** (AC: 1)
  - [ ] In `src/app/page.tsx`, update the `useReducer` to manage the states: `validating`, `analyzing`, `polling`, `generating`.
  - [ ] Add `jobId` to the reducer's state shape to store it for polling.
- [ ] **Task 2: Implement Polling Logic** (AC: 2)
  - [ ] In the API orchestration logic, when a `202 Accepted` response is received from `/api/audio/analyze`, store the `jobId`.
  - [ ] Implement a polling mechanism (e.g., using `setInterval` or a recursive `setTimeout`) that respects the defined **Polling Strategy** (exponential backoff, timeout).
  - [ ] Stop polling when the status is no longer 'processing' and proceed to the next step or handle the error.
- [ ] **Task 3: Update UI Components** (AC: 1, 4, 5)
  - [ ] Create or update an `AnalysisStatus.tsx` component to display messages for the new states.
  - [ ] Update `GenerateButton.tsx` to be disabled during all intermediate states and to show dynamic labels (e.g., "Analyzing...", "Generating...").
  - [ ] Implement conditional rendering for the `DescriptionPreview.tsx` component in `page.tsx` so it only appears in the `readyDescription` state.
- [ ] **Task 4: Implement Error Handling** (AC: 3)
  - [ ] Wrap all API calls in `try...catch` blocks.
  - [ ] In the `catch` block, dispatch an action to the reducer to set the `error` state with the message from the `ApiError` response.
  - [ ] Ensure the `ErrorBanner.tsx` component correctly displays the error message.
- [ ] **Task 5: Update Tests**
  - [ ] Update Jest unit tests for the reducer to assert correct state transitions, including the visibility of the description.
  - [ ] Update Playwright E2E tests to cover the new feedback states, error handling, and the conditional visibility of the description text area.

