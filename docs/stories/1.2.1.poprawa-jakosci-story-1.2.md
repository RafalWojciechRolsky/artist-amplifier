# <!-- Powered by BMAD™ Core -->

# Story 1.2.1: Poprawa Jakości Przesyłania Utworu do Analizy

## Status

Ready for Development

## Story

**As a** artysta,
**I want** bezpieczne i dostępne przesyłanie plików do analizy,
**so that** mogę korzystać z aplikacji bez problemów bezpieczeństwa, wydajności i dostępności.

## Acceptance Criteria

1. Bezpieczeństwo: Zaimplementowana walidacja plików po stronie serwera sprawdza format, rozmiar i zawartość pliku audio.
2. Bezpieczeństwo: Dodane ograniczenia liczby zapytań (rate limiting) dla endpointu analizy audio.
3. Dostępność: Komponent AudioUpload spełnia standardy WCAG poziom A (oznaczenia ARIA, nawigacja klawiaturą).
4. Dostępność: Komunikaty błędów są dostępne dla czytników ekranu i mają poprawne zarządzanie focusem.
5. Testy: Zwiększone pokrycie testowe obejmuje przypadki brzegowe i scenariusze błędów (błędy sieci, duże pliki).
6. Wydajność: Dodane testy wydajnościowe dla dużych plików (do 50MB).

## Tasks / Subtasks

- [x] Bezpieczeństwo: Walidacja po stronie serwera i ograniczenia (AC: 1, 2)
  - [x] Zaimplementuj endpoint `/api/validate-audio` z walidacją formatu i rozmiaru pliku
  - [x] Dodaj weryfikację zawartości pliku (sprawdzanie czy to faktycznie plik audio)
  - [x] Zaimplementuj podstawowe rate limiting (np. max 10 zapytań na 5 minut)
  - [x] Zintegruj walidację serwerową z komponentem `AudioUpload`
- [x] Dostępność (A11y): Rozszerzenie komponentu AudioUpload (AC: 3, 4)
  - [x] Dodaj brakujące atrybuty ARIA do pól formularza i komunikatów błędów
  - [x] Zaimplementuj prawidłowe zarządzanie focusem po wystąpieniu błędów
  - [x] Zapewnij pełną nawigację klawiaturą (obsługa tabindex, keydown events)
- [ ] Testy: Rozszerzenie pokrycia testowego (AC: 5)
  - [ ] Dodaj testy dla przypadków brzegowych (np. pliki na granicy dozwolonego rozmiaru)
  - [x] Dodaj testy dla scenariuszy błędów sieci (np. timeout, przerwane połączenie)
  - [ ] Rozszerz testy o symulację współbieżnych uploadów
- [ ] Wydajność: Testy dla dużych plików (AC: 6)
  - [ ] Zaimplementuj testy wydajnościowe dla uploadów dużych plików (25-50MB)
  - [ ] Dodaj opcjonalny wskaźnik postępu dla dużych plików (jeśli czas pozwala)

## Dev Notes

### Kontekst architektoniczny i komponenty

- Należy zachować istniejącą strukturę komponentów, dodając jedynie potrzebne endpointy API dla walidacji serwerowej [Source: docs/architecture/10-frontend-architecture.md]
- Implementacja route handlera w Next.js dla endpointów API [Source: docs/architecture/10-frontend-architecture.md#104-api-routes]

### Bezpieczeństwo i wydajność

- Walidacja po stronie serwera jest priorytetem dla bezpieczeństwa [Source: docs/architecture/15-security-and-performance.md#151-bezpieczestwo-mvp]
- Rate limiting można zaimplementować prostym licznikiem w pamięci dla MVP [Source: docs/architecture/15-security-and-performance.md#152-rate-limiting-mvp]
- Weryfikacja zawartości pliku powinna sprawdzać nagłówki plików audio [Source: docs/architecture/15-security-and-performance.md#153-walidacja-plikw]

### Dostępność (A11y)

- W MVP wymagamy zgodności z WCAG poziom A [Source: docs/architecture/6-components.md#65-dostpno-a11y-i-i18n-mvp]
- Nawigacja klawiaturą i oznaczenia ARIA są kluczowe dla dostępności [Source: docs/architecture/6-components.md#651-standardy-dostpnoci]

### Testing (standards)

- Należy rozszerzyć istniejące testy o brakujące przypadki [Source: docs/architecture/10-frontend-architecture.md#108-testy-mvp]
- Testy wydajnościowe mogą być wykonane za pomocą prostych miar czasowych [Source: docs/architecture/15-security-and-performance.md#155-wydajno-mvp]

### Istniejące komponenty do rozszerzenia

- `AudioUpload.tsx` - potrzebne rozszerzenie o dostępność i integrację z walidacją serwerową
- `analysis.ts` - potrzebne rozszerzenie o obsługę nowego endpointu walidacji
- Testy jednostkowe i integracyjne odpowiednich komponentów

## Testing

- Jednostkowe: walidacja pliku po stronie serwera, atrybuty ARIA, obsługa klawiatury
- Integracyjne: interakcja komponentu z API walidacji, obsługa błędów
- Wydajnościowe: pomiary czasu uploadu dużych plików

## File List

- Added: `src/app/api/validate-audio/route.ts`
- Modified: `src/lib/analysis.ts`
- Modified: `src/components/AudioUpload.tsx`
- Modified: `src/components/__tests__/AudioUpload.test.tsx`
- Modified: `src/app/__tests__/page.test.tsx`
- Modified: `src/app/__tests__/page.integration.test.tsx`

## Dev Agent Record

### Agent Model Used

- Cascade / James (@dev)

### Debug Log References

- Implemented server endpoint with MIME/size/content checks and in-memory rate limiting.
- Integrated server validation in `AudioUpload` with async state, error focus, aria-live and role=alert.
- Updated tests to mock server validation, added invalid content path and fixed cancel flow.
- All tests passing locally: `npm test` → 33 passed.

### Completion Notes

- AC 1,2,3,4 fully implemented and covered by tests.
- AC 5 partially implemented (error scenarios covered; add boundary and concurrency tests later).
- AC 6 not implemented yet (performance tests/indicator pending).

### Status

In Progress

## Change Log

| Date       | Version | Description                   | Author             |
| ---------- | ------- | ----------------------------- | ------------------ |
| 2025-08-27 | 1.0     | Initial draft for Story 1.2.1 | Bob (Scrum Master) |
| 2025-08-27 | 1.1     | Impl. server validation + A11y, integrated with UI, added tests | James (Dev) |

## QA Success Criteria

- Bezpieczeństwo: Pliki są poprawnie walidowane po stronie serwera
- Dostępność: Komponent spełnia wymagania WCAG poziom A
- Testy: Pokrycie testowe obejmuje wszystkie zidentyfikowane przypadki brzegowe i błędy
- Wydajność: Aplikacja obsługuje pliki 50MB w akceptowalnym czasie
