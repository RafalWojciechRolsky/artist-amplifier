# <!-- Powered by BMAD™ Core -->

# Story 3.2: Refactor File Upload to Use Vercel Blob

## Status

Approved

## Story

**As a** developer,
**I want** to refactor the file upload mechanism to use Vercel Blob,
**so that** the application can handle large audio files efficiently and securely.

## Acceptance Criteria

1.  The frontend file upload component is modified to request a signed URL from the backend.
2.  A new backend endpoint is created to generate and return a Vercel Blob signed URL for uploading.
3.  The file is uploaded directly from the client to Vercel Blob using the signed URL.
4.  The backend analysis endpoint is updated to accept the Vercel Blob URL of the uploaded file instead of the file itself.
5.  The application correctly handles the entire workflow: signed URL generation, file upload, and passing the URL to the analysis endpoint.
6.  The solution is compliant with the security and architecture guidelines (no keys on the client).

## Dev Notes

### Previous Story Insights

The previous story (3.1) successfully added a "Song Title" input and integrated it into the backend. The E2E tests were also added, which can be adapted for this story.

### Data Models

- **`ArtistInput`**: This interface in `src/lib/types.ts` will be modified. The `audioFileName`, `audioMimeType`, and `audioSizeBytes` will be replaced by `audioUrl: string`. [Source: docs/architecture/4-data-models.md]

### API Specifications

- **`POST /api/upload` (New)**: This new endpoint will be created to handle requests for signed URLs.
  - **Request**: `{ "filename": "song.mp3", "contentType": "audio/mpeg" }`
  - **Response**: `{ "signedUrl": "...", "url": "..." }`
- **`POST /api/audio/analyze` (Modification)**: This endpoint will be updated to accept a URL instead of a file. - **Request**: `{ "audioUrl": "..." }` - **Response**: Remains the same.
  [Source: docs/architecture/5-api-specification.md]

### File Locations

- **Frontend**:
  - `src/components/AudioUpload.tsx`: Will be refactored to use the new upload flow.
  - `src/lib/api/client.ts`: A new function will be added to call the `/api/upload` endpoint. The existing `analyzeAudio` function will be updated.
- **Backend**: - `src/app/api/upload/route.ts`: New route handler for generating signed URLs. - `src/app/api/audio/analyze/route.ts`: Will be updated to fetch the file from the provided URL.
  [Source: docs/architecture/source-tree.md]

### Technical Constraints

- Use the `@vercel/blob` npm package for blob operations.
- Ensure all sensitive keys and operations are handled on the backend.
- The client should only receive the signed URL.
  [Source: docs/architecture/3-tech-stack.md, docs/architecture/7-external-apis.md]

### Testing Requirements

- **Unit Tests**:
  - Unit tests for the new `/api/upload` endpoint.
  - Update unit tests for the `/api/audio/analyze` endpoint.
  - Update unit tests for the `AudioUpload` component.
- **E2E Tests**: - Update the E2E smoke tests to reflect the new upload mechanism.
  [Source: docs/architecture/17-coding-standards.md]

## Tasks / Subtasks

- [ ] **Task 1: Backend - Signed URL Endpoint** (AC: 2)
  - [ ] Install the `@vercel/blob` package.
  - [ ] Create a new route handler at `src/app/api/upload/route.ts`.
  - [ ] Implement the logic to generate a signed URL using the Vercel Blob SDK.
  - [ ] Add unit tests for the new endpoint.
- [ ] **Task 2: Frontend - Refactor Upload Component** (AC: 1, 3)
  - [ ] Create a new API client function in `src/lib/api/client.ts` to fetch the signed URL.
  - [ ] Modify `src/components/AudioUpload.tsx` to call the new API function.
  - [ ] Implement the logic to upload the file to the signed URL from the client.
  - [ ] Update unit tests for the `AudioUpload` component.
- [ ] **Task 3: Backend - Update Analysis Endpoint** (AC: 4)
  - [ ] Modify `src/app/api/audio/analyze/route.ts` to accept a URL.
  - [ ] Implement the logic to download the file from the URL before sending it to Music.ai.
  - [ ] Update unit tests for the endpoint.
- [ ] **Task 4: E2E Testing** (AC: 5, 6)
  - [ ] Update the Playwright E2E tests to cover the new upload flow.

## Change Log

| Date       | Version | Description   | Author             |
| ---------- | ------- | ------------- | ------------------ |
| 2025-09-02 | 1.0     | Initial draft | Bob (Scrum Master) |

## QA Results

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.2-refactor-file-upload-to-use-vercel-blob.yml
