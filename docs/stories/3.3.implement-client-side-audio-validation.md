# <!-- Powered by BMADâ„¢ Core -->

# Story 3.3: Implement Client-Side Audio Validation

## Status

Done

## Story

**As a** user,
**I want** to receive immediate feedback on whether my audio file meets the platform's requirements before I upload it,
**so that** I don't waste time uploading an invalid file.

## Acceptance Criteria

1.  Before the upload process begins, the selected audio file is validated on the client-side.
2.  The file is checked against the following Music.AI requirements:
    - Maximum file size: 50MB
    - Maximum duration: 10 minutes
3.  If the file is invalid, a clear and user-friendly error message is displayed, specifying the reason (e.g., "File is too large," "Audio is too long").
4.  If the file is valid, the upload process proceeds as normal.
5.  The validation logic is implemented in a way that does not block the UI for an extended period.

## Dev Notes

### Previous Story Insights

Story 3.2 refactored the file upload to use Vercel Blob, which is now the standard. This new validation logic should be integrated into the `AudioUpload.tsx` component.

### File Locations

- The validation logic should be added to `src/components/AudioUpload.tsx`.
- If a new utility function is created, it should be placed in `src/lib/utils.ts`. [Source: docs/architecture/source-tree.md]

### Technical Constraints

- The validation should happen client-side.
- To get the audio duration, you will likely need to use the `window.Audio` object or a lightweight library. Avoid adding heavy dependencies. Check `tech-stack.md` for any existing audio libraries. [Source: docs/architecture/10-frontend-architecture.md]

### Component Specifications

- The `AudioUpload` component in `src/components/AudioUpload.tsx` should be modified to include the validation logic.
- The component should display an error message to the user if validation fails. [Source: docs/architecture/6-components.md]

### Testing Requirements

- Add unit tests for the new validation logic.
- Update E2E tests to cover the validation scenarios (valid file, invalid file size, invalid duration). [Source: docs/architecture/coding-standards.md]

## Tasks / Subtasks

- [x] **Task 1: Implement Audio Validation Logic** (AC: 1, 2)
  - [x] In `src/lib/utils.ts`, create a new function `validateAudioFile(file: File): Promise<{ isValid: boolean; message?: string }>`
  - [x] Inside this function, implement the logic to check the file size (max 50MB).
  - [x] Implement the logic to get the audio duration using the `Audio` object and check if it's under 10 minutes.
- [x] **Task 2: Integrate Validation into Upload Component** (AC: 3, 4)
  - [x] In `src/components/AudioUpload.tsx`, call the `validateAudioFile` function when a file is selected.
  - [x] If validation fails, display the error message from the validation function.
  - [x] If validation passes, proceed with the existing upload flow.
- [x] **Task 3: Unit and E2E Tests** (AC: 5)
  - [x] Add unit tests for the `validateAudioFile` function.
  - [x] Add/update E2E tests in `tests/e2e/` to cover the new validation scenarios.

## QA Results

### Review Date: 2025-09-03

### Reviewed By: Quinn (Test Architect)

#### Pre-Development Review

This pre-development review finds the story to be well-structured and low-risk.

#### Post-Development Review

The implementation has been verified and meets all acceptance criteria.

- **Implementation:** The validation logic in `src/lib/utils.ts` and its integration into `src/components/AudioUpload.tsx` are correct and handle all specified cases (file size, duration, invalid format).
- **Unit Tests:** The `validateAudioFile` function is thoroughly tested in `src/lib/__tests__/utils.test.ts`, covering valid, oversized, over-duration, and invalid file scenarios.
- **E2E Tests:** The end-to-end tests in `tests/e2e/audio-validation.spec.ts` successfully validate the user-facing error messages and behavior for all validation cases.
- **Accessibility:** The component correctly manages focus and uses ARIA attributes for error reporting.

The feature is implemented to a high standard of quality.

### Gate Status

PASS
