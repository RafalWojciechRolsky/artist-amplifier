# <!-- Powered by BMAD™ Core -->

# Story 2.1: Integracja Music.ai w BFF (real)

## Status

Draft

## Story

**As a** user,
**I want** the application to use the real Music.ai service for audio analysis,
**so that** the generated description is based on actual track characteristics.

## Acceptance Criteria

1.  A real call to the Music.ai service is made when generating a description.
2.  Errors from the Music.ai service are mapped to the standard `ApiError` format with codes 502 or 429 and include a `requestId`.
3.  There are no changes to the request format from the frontend, and the frontend (`src/lib/api/generate.ts`) continues to work without modification.
4.  The `.env.example` and `README.md` files are updated with the new environment variables `MUSIC_AI_API_KEY` and `MUSIC_AI_WORKFLOW_ANALYZE`.

## Dev Notes

### Previous Story Insights

No specific guidance found in architecture docs

### API Specifications

- The BFF is responsible for orchestrating the call to Music.ai. [Source: docs/architecture/5-api-specification.md]
- The BFF should save the uploaded file to a temporary location (e.g., `/tmp`) before calling the Music.ai SDK. [Source: docs/architecture/7-external-apis.md]
- The Music.ai SDK will be used for the integration: `uploadFile`, `addJob`, `waitForJobCompletion`. [Source: docs/architecture/7-external-apis.md] and [Source: docs/externalDocs/music.ai.md]
- The workflow ID will be stored in the `MUSIC_AI_WORKFLOW_ANALYZE` environment variable. [Source: docs/architecture/7-external-apis.md]
- The result from `job.result` should be mapped to the `AudioAnalysis` data model. [Source: docs/architecture/7-external-apis.md] and [Source: docs/externalDocs/music.ai.md]
- Implement a retry mechanism with exponential backoff for 429/5xx errors from Music.ai. [Source: docs/architecture/7-external-apis.md] and [Source: docs/externalDocs/music.ai.md]

### Data Models

- `AudioAnalysis`: `{ durationSec: number, bpm?: number, musicalKey?: string, energy?: number }`. [Source: docs/architecture/data-models.md]
- `ApiError`: `{ error: { code: string, message: string, details?: Record<string, any>, timestamp: string, requestId: string } }`. [Source: docs/architecture/data-models.md]

### File Locations

- The Music.ai integration logic should be placed in `src/lib/server/musicai.ts`. [Source: docs/architecture/11-backend-architecture-opcjonalny-bff.md]
- The main orchestration logic is in `src/app/api/audio/generate/route.ts`. [Source: docs/architecture/11-backend-architecture-opcjonalny-bff.md]

### Testing Requirements

- Unit tests should be created for the Music.ai integration, mocking the SDK. [Source: docs/architecture/10-frontend-architecture.md#108-testy-mvp]

## Tasks / Subtasks

- [ ] Create a new file `src/lib/server/musicai.ts` for the Music.ai integration. (AC: 1)
  - [ ] Implement a function that takes a file path as input.
  - [ ] Inside the function, use the `@music.ai/sdk` to upload the file, create a job, and wait for completion.
  - [ ] Map the job result to the `AudioAnalysis` data model.
  - [ ] Implement retry logic for 429/5xx errors.
- [ ] Update the `src/app/api/audio/generate/route.ts` file to use the new Music.ai integration. (AC: 1, 2, 3)
  - [ ] Save the uploaded audio file to a temporary directory.
  - [ ] Call the function from `src/lib/server/musicai.ts` with the temporary file path.
  - [ ] Handle errors from the Music.ai integration and map them to the `ApiError` format.
- [ ] Update the `.env.example` file with the `MUSIC_AI_API_KEY` and `MUSIC_AI_WORKFLOW_ANALYZE` variables. (AC: 4)
- [ ] Update the `README.md` file to document the new environment variables. (AC: 4)
- [ ] Create unit tests for the `src/lib/server/musicai.ts` file, mocking the `@music.ai/sdk`. (AC: 1, 2)

## Change Log

| Date       | Version | Description                 | Author             |
| ---------- | ------- | --------------------------- | ------------------ |
| 2025-08-29 | 1.0     | Initial draft for Story 2.1 | Bob (Scrum Master) |

## QA Results

### Gate Status

Gate: FAIL → docs/qa/gates/2.1-integracja-music-ai-w-bff.yaml
