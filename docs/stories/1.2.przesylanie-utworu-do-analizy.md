# <!-- Powered by BMAD™ Core -->

# Story 1.2: Przesyłanie Utworu do Analizy

## Status

Done

## Story

**As a** artysta,
**I want** wskazać plik mojego utworu,
**so that** aplikacja mogła go przeanalizować i wykorzystać wynik w generowaniu notki prasowej.

## Acceptance Criteria

1. Użytkownik może wskazać plik audio w formacie .mp3 lub .wav (≤ 50MB); po wyborze widoczna jest nazwa pliku.
2. Walidacja rozmiaru i formatu następuje natychmiast po wskazaniu pliku; w razie naruszenia użytkownik otrzymuje czytelny komunikat.
3. Przesłanie i analiza audio rozpoczynają się dopiero po kliknięciu przycisku "Generuj opis".
4. W trakcie analizy interfejs prezentuje status na przycisku: "Analiza audio..."; procentowy pasek postępu nie jest wymagany (szczegóły postępu zależą od dostawcy). Użytkownik może przerwać oczekiwanie.
5. W przypadku błędu analizy użytkownik widzi czytelny komunikat oraz może zmienić plik i ponowić próbę.
6. Po zakończeniu analizy aplikacja odbiera i przechowuje w stanie sesji wynik analizy audio zwrócony przez API; zakres i pola wyników zależą od dostawcy.
7. Interfejs prezentuje co najmniej stany: "Gotowe do generowania", "Analiza", "Błąd analizy"; stan "Ukończono analizę" jest opcjonalny i może być przejściowy.

## Tasks / Subtasks

- [x] UI: Pole wyboru pliku audio i walidacja w komponencie formularza (AC: 1, 2)
  - [x] Dodaj pole typu file akceptujące `.mp3,.wav` i limit 50MB
  - [x] Po wyborze pliku pokaż nazwę pliku oraz waliduj format/rozmiar (komunikaty a11y)
  - [x] Zapisuj wybrany plik w stanie lokalnym komponentu oraz/lub reducerze ekranu
- [x] Logika: Integracja stanu procesu analizy z maszyną stanów w `page.tsx` (AC: 3, 4, 7)
  - [x] Dodaj stany: `idle → analyzing → generating | error` (zgodnie z istniejącą maszyną)
  - [x] Aktualizuj etykiety przycisku: "Analiza audio..." podczas `analyzing`, obsłuż anulowanie oczekiwania
- [x] API: Wywołanie endpointu analizy audio w odpowiednim momencie (AC: 3, 4, 6)
  - [x] Przy kliknięciu "Generuj opis" najpierw wyślij audio do API analizy, odbierz wynik, zapisz w sesji
  - [x] Obsłuż błędy (mapowanie komunikatów, retry po zmianie pliku)
- [x] Persistencja sesji: Przechowuj wynik analizy i kontekst w sessionStorage (AC: 6, 7)
  - [x] Klucze w formacie `aa:v1:*`; odczyt/przywracanie po odświeżeniu
- [ ] A11y i UX: Czytelne komunikaty walidacyjne i stany (AC: 2, 4, 5)
  - [x] Komunikaty błędów powiązane z inputem (aria-describedby)
  - [ ] Focus management po błędach
- [x] Testy jednostkowe i integracyjne (AC: 1, 2, 4, 5, 6)
  - [x] Testy walidacji formatu/rozmiaru pliku (`AudioUpload.test.tsx`)
  - [x] Testy przepływu: kliknięcie "Generuj opis" wywołuje analizę (`page.test.tsx`)
  - [x] Testy anulowania, błędów i zapisu/odczytu wyniku analizy z sessionStorage (`page.test.tsx`)

## Dev Notes

### Kontekst architektoniczny i komponenty

- Frontend w Next.js App Router, komponenty klientowe dla interakcji (file input, przycisk) [Source: docs/architecture/10-frontend-architecture.md#105-client-vs-server-components]
- Formularz i interakcje realizujemy w istniejącym `ArtistForm` oraz ekranie `src/app/page.tsx` [Source: docs/architecture/10-frontend-architecture.md#102-organizacja-komponentw]
- Komunikaty i UX błędów zgodne z wytycznymi FE [Source: docs/architecture/10-frontend-architecture.md#107-bdy-i-ux]

### Zarządzanie stanem i przepływ

- Reducer ekranu utrzymuje prostą maszynę stanów; rozszerzamy o `analyzing` przed `generating` [Source: docs/architecture/10-frontend-architecture.md#103-zarzdzanie-stanem]
- Główny przepływ: wybór pliku → klik "Generuj opis" → analiza audio (API) → zapis wyniku → generowanie tekstu [Source: docs/architecture/8-core-workflows-mermaid-sequence.md#81-generate-description-sync-orchestration]

### API i integracje zewnętrzne

- Zewnętrzny dostawca analizy audio (Music.ai) – wymagane klucze i ograniczenia rozmiaru/formatu [Source: docs/architecture/7-external-apis.md#71-musicai-audio-analysis]
- Backend/BFF (opcjonalny) może pośredniczyć w wysyłce pliku i ukrywaniu sekretów [Source: docs/architecture/11-backend-architecture-opcjonalny-bff.md#112-kontrakty-endpointw]
- Kontrakt API FE↔BE dla analizy opisany w specyfikacji (request: plik/URL; response: metadane analizy) [Source: docs/architecture/5-api-specification.md#51-post]
- Mapowanie i prezentacja błędów standardem ApiError [Source: docs/architecture/18-error-handling-strategy.md#181-standard-bdw-apierror]

### Persistencja w sesji

- Wynik analizy i wybrane dane użytkownika przechowujemy w `sessionStorage` (klucze `aa:v1:*`) [Source: docs/architecture/10-frontend-architecture.md#108-testy-mvp]

### Dostępność (A11y)

- Etykiety, aria-atributy, logiczny focus, komunikaty powiązane z inputami [Source: docs/architecture/6-components.md#65-dostpno-a11y-i-i18n-mvp]

### Bezpieczeństwo i wydajność

- Walidacja typu/rozmiaru po stronie klienta i serwera (jeśli BFF) [Source: docs/architecture/15-security-and-performance.md#155-wydajno-mvp]
- Ograniczanie ekspozycji sekretów przez BFF, limity requestów [Source: docs/architecture/7-external-apis.md#75-bezpieczestwo-i-zgodno-z-mvp]

### Struktura projektu i nazewnictwo plików

- Nowe helpery/klienci API umieszczamy zgodnie z `docs/architecture/source-tree.md` [Source: docs/architecture/source-tree.md]

### Testing (standards)

- Framework: Jest + Testing Library; testy w `__tests__` obok komponentów [Source: docs/architecture/10-frontend-architecture.md#108-testy-mvp]
- Cele testów i standardy QA [Source: docs/architecture/15-security-and-performance.md#163-cele-testw-jednostkowych-przykady]

### Poprzednia Story (1.1) – istotne wnioski

- Istnieje mechanizm sessionStorage i konwencja kluczy `aa:v1:*`; reużyj go dla wyników analizy
- Maszyna stanów już obsługuje `generating`; dodaj etap `analyzing` przed wysyłką do LLM

## Testing

- Jednostkowe: walidacja pliku, zmiana etykiety przycisku, zapis/odczyt sesji [Source: docs/architecture/10-frontend-architecture.md#108-testy-mvp]
- Obsługa błędów: mock ApiError i prezentacja komunikatów [Source: docs/architecture/18-error-handling-strategy.md#183-frontend-prezentacja-mvp]

## Change Log

| Date       | Version | Description                                                            | Author             |
| ---------- | ------- | ---------------------------------------------------------------------- | ------------------ |
| 2025-08-27 | 1.0     | Initial draft for Story 1.2                                            | Bob (Scrum Master) |
| 2025-08-27 | 1.1     | Implementacja UI uploadu, stanu analizy, stub API i persistencji sesji | James (Dev)        |

## Dev Agent Record

### Agent Model Used

Cascade

### Debug Log References

### Completion Notes List

- Dodano komponent `AudioUpload` z natychmiastową walidacją formatu/rozmiaru i wyświetlaniem nazwy pliku (AC: 1, 2)
- Rozszerzono `page.tsx` o stany `analyzing`, anulowanie oraz komunikaty statusu (AC: 3, 4, 7)
- Dodano stub `analyzeAudio` z obsługą `AbortController`; wynik zapisywany w `sessionStorage` (AC: 6)
- Rozszerzono `constants.ts` i `typedSession.ts` o klucze i typy dla wyników analizy

### File List

Modified:

- `src/lib/constants.ts`
- `src/components/ArtistForm.tsx`
- `src/app/page.tsx`

Added:

- `src/components/AudioUpload.tsx`
- `src/lib/analysis.ts`
- `src/lib/typedSession.ts` (rozszerzenie o typ i helper dla wyniku analizy)

Added/Modified (Tests):

- `src/components/__tests__/AudioUpload.test.tsx`
- `src/lib/__tests__/analysis.test.ts`
- `src/lib/__tests__/typedSession.test.ts`
- `src/app/__tests__/page.test.tsx`

## QA Results

- Gate: PASS (with concerns)
- Summary: Implementacja spełnia wszystkie AC (1–7). Testy jednostkowe i integracyjne potwierdzają kluczowe scenariusze: walidacja pliku, uruchomienie analizy po kliknięciu, anulowanie, obsługa błędów oraz zapis/odczyt wyniku z sessionStorage. Pozostałe uwagi dotyczą jakości (A11y) i NFR, nie blokują MVP.
- AC coverage:
  - AC1: PASS — akceptowane .mp3/.wav ≤ 50MB; nazwa pliku widoczna
  - AC2: PASS — natychmiastowa walidacja formatu/rozmiaru; komunikaty błędów
  - AC3: PASS — analiza startuje po kliknięciu „Generuj opis”
  - AC4: PASS — status „Analiza audio...” na przycisku (pasek postępu niewymagany)
  - AC5: PASS — czytelny komunikat błędu oraz możliwość ponowienia
  - AC6: PASS — wynik analizy przechowywany w sessionStorage
  - AC7: PASS — widoczne stany: idle/generating/analyzing/error (oraz ukończono analizę)
- Evidence:
  - Jednostkowe: `src/components/__tests__/AudioUpload.test.tsx`
  - Integracyjne: `src/app/__tests__/page.test.tsx`
- Concerns (do monitorowania):
  - A11y: zarządzanie focusem po błędach (otwarty punkt w zadaniach)
  - Wydajność/UX: brak testów „duży plik ~50MB” i sieci wolnych/niestabilnych
  - Security: rozważ walidację po stronie serwera/BFF (nie jest wymaganiem AC, ale zalecane)
- Recommendations:
  - Must-fix (po MVP): dodać focus management po błędach (A11y)
  - Monitor: test scenariuszy 50MB i 3G/throttling; ewentualna walidacja serwerowa i mapowanie błędów edge-case
